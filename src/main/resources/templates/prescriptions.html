<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <title>Prescriptions</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <style>
        .card-surface--wide { max-width: 1200px; padding: 1.25rem 1rem; }
        .table-wrapper { overflow-x: auto; overflow-y: auto; max-height: 60vh; background: #fff; border-radius: 8px; box-shadow: 0 0 0 1px rgba(0,0,0,0.02) inset; }
        .table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .table th, .table td { padding: 0.6rem 0.75rem; border-bottom: 1px solid rgba(0,0,0,0.05); text-align: left; vertical-align: top; word-break: break-word; overflow-wrap: anywhere; }
        .table thead th { position: sticky; top: 0; background: #fff; z-index: 2; font-weight: 600; font-size: 0.95rem; color: #123; }
        .highlighted-row { animation: highlightFlash 1.6s ease-in-out; }
        @keyframes highlightFlash { 0% { background: #fff8c6; } 60% { background: #fff8c6; } 100% { background: transparent; } }
        .filter-row { display: flex; gap: 0.5rem; align-items: flex-end; width: 100%; margin-bottom: 0.75rem; }
        .filter-row label { display: block; }
        .filter-row .search-input { flex: 1 1 0; min-width: 140px; }
        .filter-row .btn-filter { flex: 0 0 auto; min-width: 96px; padding: 0.85rem 0; }

        /* Modal Styles */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal-content { background: var(--card-blue); border-radius: 20px; padding: 2rem; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; margin: 2rem; }

        /* Button Styles */
        .btn-edit { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); }
        .btn-delete { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); }
        .btn-cancel { background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%); }

        .action-buttons { display: flex; gap: 0.5rem; }
        .btn-small { padding: 0.4rem 0.8rem; font-size: 0.85rem; width: auto; margin-top: 0; }

        @media (max-width:700px){
            .filter-row{flex-wrap:wrap;}
            .filter-row .btn-filter{min-width:100%;}
            .card-surface--wide{padding:1rem;margin:0.5rem;}
            .action-buttons { flex-direction: column; }
            .btn-small { width: 100%; }
        }
    </style>
</head>
<body>
<div class="card-surface card-surface--wide" role="main" style="margin:2rem auto;">
    <div class="medical-header">
        <div class="medical-icon">üíä</div>
        <h2>Prescriptions</h2>
        <p class="medical-subtitle">Manage your prescriptions ‚Äî date range, search, and create.</p>
    </div>

    <!-- Flash messages -->
    <div th:if="${success}" class="alert alert-success" th:text="${success}" style="margin-bottom:1rem;"></div>
    <div th:if="${error}" class="alert alert-error" th:text="${error}" style="margin-bottom:1rem;"></div>

    <!-- Filter form -->
    <form method="get" th:action="@{/prescriptions}" class="filter-row" style="margin-bottom:0.75rem;">
        <label>
            <div class="small-muted">Start</div>
            <input type="date" name="start" class="form-control" th:value="${start}" />
        </label>
        <label>
            <div class="small-muted">End</div>
            <input type="date" name="end" class="form-control" th:value="${end}" />
        </label>
        <label style="flex:1">
            <div class="small-muted">Search patient</div>
            <input type="text" name="q" class="form-control search-input" placeholder="Patient name" th:value="${q}" />
        </label>
        <button type="submit" class="btn-medical btn-filter btn-medical--inline">Filter</button>
    </form>


    <hr style="margin:1.25rem 0; border:none; height:1px; background: rgba(0,0,0,0.06)">
    <div style="display:flex; justify-content:center; margin-bottom:0.5rem;">
        <a th:href="@{/prescriptions/report-page}"
           style="font-size:1.3rem; text-decoration:none;">
            üìä
        </a>
    </div>
    <!-- Prescriptions table -->
    <div th:if="${prescriptions.content.size() > 0}">

        <div class="table-wrapper">

            <table class="table" aria-describedby="prescriptions">
                <thead>
                <tr>
                    <th>Date</th>
                    <th>Patient</th>
                    <th>Age</th>
                    <th>Gender</th>
                    <th>Diagnosis</th>
                    <th>Medicines</th>
                    <th>Next visit</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="p : ${prescriptions.content}" th:attr="id=${'p-' + p.id}">
                    <td th:text="${p.prescriptionDate}">2025-01-01</td>
                    <td th:text="${p.patientName}">John Doe</td>
                    <td th:text="${p.patientAge}">30</td>
                    <td th:text="${p.patientGender}">MALE</td>
                    <td th:text="${p.diagnosis}">Diagnosis</td>
                    <td th:text="${p.medicines}">Medicine</td>
                    <td th:text="${p.nextVisitDate}">2025-02-01</td>
                    <td>
                        <div class="action-buttons">
                            <button type="button" class="btn-medical btn-small btn-edit"
                                    th:onclick="'openEditModal(' + ${p.id} + ')'" title="Edit">
                                ‚úèÔ∏è
                            </button>
                            Ô∏è
                            </button>
                            <form th:action="@{'/prescriptions/' + ${p.id} + '/delete'}" method="post"
                                  class="inline-delete-form"
                                  onsubmit="return confirm('Delete this prescription?');">
                                <button type="submit" class="btn-medical btn-small btn-delete" title="Delete">
                                    üóëÔ∏è
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div th:if="${prescriptions.content.size() == 0}">
        <div class="alert alert-info">No prescriptions found.</div>
    </div>

    <!-- Create prescription form -->
    <div style="margin-top:1.5rem; background:#fff; padding:1rem; border-radius:12px;">
        <h3>Create Prescription</h3>
        <form th:action="@{/prescriptions/create}" method="post">
            <div class="form-group">
                <label>Prescription date</label>
                <input type="date" class="form-control" name="prescriptionDate" required/>
            </div>
            <div class="form-group">
                <label>Patient name</label>
                <input type="text" class="form-control" name="patientName" required/>
            </div>
            <div class="form-group" style="display:flex; gap:0.5rem;">
                <div style="flex:1">
                    <label>Age</label>
                    <input type="number" class="form-control" name="patientAge" min="0" max="150" required/>
                </div>
                <div style="width:160px;">
                    <label>Gender</label>
                    <select class="form-control" name="patientGender" required>
                        <option value="MALE">Male</option>
                        <option value="FEMALE">Female</option>
                        <option value="OTHER">Other</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Diagnosis</label>
                <textarea class="form-control" name="diagnosis" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label>Medicines</label>
                <textarea class="form-control" name="medicines" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label>Next visit date</label>
                <input type="date" class="form-control" name="nextVisitDate"/>
            </div>
            <button type="submit" class="btn-medical">Create</button>
        </form>
    </div>
</div>

<!-- Edit Prescription Modal -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
            <h3>Edit Prescription</h3>
            <button type="button" onclick="closeEditModal()" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color: var(--dark-blue);">&times;</button>
        </div>

        <form id="editForm" method="post">
            <input type="hidden" id="editPrescriptionId" name="id"/>

            <div class="form-group">
                <label>Prescription date</label>
                <input type="date" class="form-control" id="editPrescriptionDate" name="prescriptionDate" required/>
            </div>
            <div class="form-group">
                <label>Patient name</label>
                <input type="text" class="form-control" id="editPatientName" name="patientName" required/>
            </div>
            <div class="form-group" style="display:flex; gap:0.5rem;">
                <div style="flex:1">
                    <label>Age</label>
                    <input type="number" class="form-control" id="editPatientAge" name="patientAge" min="0" max="150" required/>
                </div>
                <div style="width:160px;">
                    <label>Gender</label>
                    <select class="form-control" id="editPatientGender" name="patientGender" required>
                        <option value="MALE">Male</option>
                        <option value="FEMALE">Female</option>
                        <option value="OTHER">Other</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Diagnosis</label>
                <textarea class="form-control" id="editDiagnosis" name="diagnosis" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label>Medicines</label>
                <textarea class="form-control" id="editMedicines" name="medicines" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label>Next visit date</label>
                <input type="date" class="form-control" id="editNextVisitDate" name="nextVisitDate"/>
            </div>

            <div style="display:flex; gap:0.5rem; margin-top:1.5rem;">
                <button type="button" onclick="closeEditModal()" class="btn-medical btn-cancel" style="flex:1;">Cancel</button>
                <button type="submit" class="btn-medical" style="flex:1;">Update Prescription</button>
            </div>
        </form>
    </div>
</div>

<script>
    function openEditModal(prescriptionId) {
        fetch('/prescriptions/' + prescriptionId + '/edit')
            .then(res => {
                if (!res.ok) throw new Error('Failed to fetch prescription');
                return res.json();
            })
            .then(data => {
                // Populate modal fields
                document.getElementById('editPrescriptionId').value = data.id;
                document.getElementById('editPrescriptionDate').value = data.prescriptionDate;
                document.getElementById('editPatientName').value = data.patientName;
                document.getElementById('editPatientAge').value = data.patientAge;
                document.getElementById('editPatientGender').value = data.patientGender;
                document.getElementById('editDiagnosis').value = data.diagnosis || '';
                document.getElementById('editMedicines').value = data.medicines || '';
                document.getElementById('editNextVisitDate').value = data.nextVisitDate || '';


                const form = document.getElementById('editForm');
                form.action = '/prescriptions/' + prescriptionId + '/update';

                const modal = document.getElementById('editModal');
                modal.style.display = 'flex';
            })
            .catch(err => {
                console.error(err);
                alert('Error loading prescription data');
            });
    }

    function closeEditModal() {
        const modal = document.getElementById('editModal');
        modal.style.display = 'none';
    }

    document.getElementById('editModal').addEventListener('click', function(e) {
        if (e.target.id === 'editModal') closeEditModal();
    });


    document.getElementById('editForm').addEventListener('submit', function(e) {

    });
</script>

</body>
</html>